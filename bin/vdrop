#!/bin/bash
# vdrop - Discard changes or abandon commits
#
# Unified wrapper for discarding work. In jj repos, abandons the
# specified revision. In git repos, resets changes. Prompts for
# confirmation when the reset would move HEAD (destructive operation).
#
# Usage:
#   vdrop [args...]
#
# Examples:
#   vdrop              # reset all changes (git)
#   vdrop HEAD~1       # reset to previous commit (git, prompts)
#   vdrop @            # abandon current change (jj)

[[ "$1" == "--describe" ]] && echo "Discard changes or abandon commits" && exit 0

if [[ "$1" == "--help" ]]; then
    echo "Usage: vdrop [args...]"
    echo ""
    echo "Discard changes or abandon commits."
    echo "  jj: runs 'jj abandon'"
    echo "  git: runs 'git reset'"
    echo ""
    echo "In git mode, prompts for confirmation when arguments are"
    echo "provided (since this may move HEAD and discard commits)."
    exit 0
fi

vcs_info=$(vdetect) || exit 1
vcs="${vcs_info%% *}"

if [[ "$vcs" == "jj" ]]; then
    jj abandon "$@"
    exit 0
fi

# If arguments are provided, the reset may move HEAD (destructive)
if [[ $# -gt 0 ]]; then
    echo "WARNING: git reset $* may move HEAD and discard commits."
    read -rp "Continue? [y/N] " confirm
    if [[ "$confirm" != [yY] ]]; then
        echo "Aborted."
        exit 1
    fi
fi

git reset "$@"
