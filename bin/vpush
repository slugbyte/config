#!/bin/bash

if [[ -d ./.jj ]]; then
    branch="${1:-main}"
    jj bookmark set "$branch" -r @- --allow-backwards
    jj git push -r "$branch"
    exit 0
fi

# Parse arguments
branch=""
force=""

for arg in "$@"; do
    case "$arg" in
        -f|--force)
            force="--force"
            ;;
        *)
            if [[ -z "$branch" ]]; then
                branch="$arg"
            fi
            ;;
    esac
done

# Get current branch if branch not specified or is '-'
if [[ -z "$branch" || "$branch" == "-" ]]; then
    branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
    if [[ "$branch" == "HEAD" ]]; then
        echo "ERROR: cannot push from detached state."
        exit 1
    fi
fi

echo "git push origin $branch $force"

if [[ -n "$force" ]]; then
    git push origin "$branch" --tags $force
else
    git push origin "$branch" --tags
fi
